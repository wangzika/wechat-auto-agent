# main_agent.py
import schedule
import time
from generator import generate_article
from formatter import markdown_to_html
from publisher import get_access_token, upload_material, send_article, upload_image_material

def automated_publishing_task(topic: str):
    """
    全自动文章生成和发布流程。
    """
    print(f"\n--- 🤖 自动化发布 Agent 任务开始：主题【{topic}】---")
    
    # 1. 获取 Access Token
    access_token = get_access_token()
    if not access_token:
        print("❌ 无法获取 Access Token，任务终止。")
        return

    # 2. 生成文章内容
    # article_md = generate_article(topic, word_count=2000)
    article_md = '# AI Agent\n\n> 算法与创意的完美融合，正在重新定义内容生产的边界。\n\n当OpenAI发布GPT-4时，全球内容创作者既兴奋又担忧——兴奋于AI写作能力的飞跃，担忧于自己可能被取代。然而，最新一代AI Agent技术正在超越简单的文本生成，展现出令人惊叹的**自主创作能力**。\n\n这些智能体不仅能撰写文章，还能自主策划内容主题、分析受众偏好、优化发布策略，甚至根据反馈进行迭代改进。它们正成为内容创作领域的“超级大脑”，彻底改变着内容生产的游戏规则。\n\n---\n\n# 01 智能进化：从工具到合作伙伴\n\n传统AI写作工具大多停留在“指令-输出”的简单模式，而新一代AI Agent则展现出前所未有的自主性。这些智能体能够理解复杂任务，拆解为可执行的子任务，并自主完成整个创作流程。\n\n以AI内容创作平台Jasper为例，其最新版本已不再是简单的文本生成器，而是一个能够理解品牌调性、分析目标受众、策划内容日历的智能创作伙伴。\n\n它可以根据市场趋势自动调整内容方向，甚至能够预测哪些话题将在未来几周内获得更高关注度。\n\n更令人印象深刻的是，某些先进AI Agent已经能够进行跨模态创作。它们不仅生成文字，还能自主设计配图、制作信息图表、编辑短视频，并确保所有内容元素在风格和主题上保持一致。\n\n这种多模态创作能力使AI Agent从“写作助手”升级为“全媒体内容生产者”。\n\n# 02 核心技术：三大突破驱动变革\n\nAI Agent在内容创作领域的突破，主要得益于三大技术进展：\n\n**自主任务分解与规划能力**：现代AI Agent能够将“创作一篇关于AI伦理的深度文章”这样的复杂指令，分解为“研究最新AI伦理争议”、“分析不同立场观点”、“构建论证框架”、“撰写初稿”、“优化语言表达”等一系列子任务，并自主规划执行顺序。\n\n**持续学习与自适应优化**：通过强化学习技术，AI Agent能够根据内容表现数据（如阅读量、互动率、转化率）不断调整创作策略。例如，如果某类话题的打开率持续下降，Agent会自动减少类似内容的产出，转而探索更受关注的方向。\n\n**多智能体协作系统**：最前沿的AI Agent系统采用多个专业智能体协作模式。一个系统中可能包含“研究Agent”、“写作Agent”、“编辑Agent”和“优化Agent”，它们各司其职又相互配合，共同完成高质量内容创作。\n\n这种分工协作模式大幅提升了内容产出的专业度和效率。\n\n# 03 行业应用：四大场景深度变革\n\n**规模化内容生产**：新闻机构如美联社早已使用AI自动生成财经报道和体育赛事总结。现在，更先进的AI Agent能够根据同一组数据生成不同角度、不同风格的多篇报道，满足不同媒体平台的差异化需求。\n\n**个性化内容定制**：电商平台利用AI Agent为每位用户生成个性化的产品描述和推荐内容。系统能够分析用户的浏览历史、购买记录和偏好，创作出极具针对性的营销文案，显著提升转化率。\n\n**跨语言内容创作**：AI Agent能够以源语言创作内容，然后自动适配到多种目标语言，同时保持原文的风格、语气和文化适应性。这种能力正在打破内容传播的语言壁垒。\n\n**交互式内容体验**：一些教育平台开始使用AI Agent创建自适应学习材料。系统能够根据学生的学习进度和理解程度，动态调整内容的难度、呈现方式和练习题目，提供真正个性化的学习体验。\n\n# 04 质量革命：超越模板化创作\n\n早期AI生成内容常被诟病为“模板化”、“缺乏灵魂”，但最新AI Agent通过多种技术手段显著提升了内容质量：\n\n**风格迁移与适配**：高级AI Agent能够精确模仿特定作者或媒体的写作风格。无论是《纽约客》的深度长文风格，还是科技博客的简洁明快风格，AI都能高度还原，使生成内容与目标平台完美契合。\n\n**事实核查与溯源**：为避免“AI幻觉”问题，新一代Agent集成了事实核查模块。在生成涉及事实陈述的内容时，系统会自动检索可靠信源，验证信息准确性，并在必要时添加引用标注。\n\n**情感智能与共情表达**：通过情感计算技术，AI Agent能够识别不同内容所需的情感基调，并相应调整语言表达。无论是鼓舞人心的励志文章，还是严谨客观的学术论述，AI都能准确把握情感尺度。\n\n**创意发散与创新**：令人惊讶的是，一些AI Agent已展现出一定的创造性思维能力。它们能够将不同领域的知识进行新颖组合，提出独特视角，甚至生成富有诗意的表达，这在以往被认为是人类创作的专属领域。\n\n# 05 伦理挑战：在创新与责任之间\n\n随着AI Agent在内容创作领域的深入应用，一系列伦理问题也随之浮现：\n\n**版权与原创性边界**：当AI生成内容高度类似某位作家的风格，这是模仿还是侵权？当AI基于数百万篇文章训练后生成“原创”内容，版权归属如何界定？这些法律灰色地带亟待明确。\n\n**内容真实性危机**：AI生成高度逼真但完全虚构的“新闻”已成为可能。如何防止恶意使用AI Agent制造虚假信息，是行业面临的重大挑战。\n\n**人类创作者的价值重定位**：当AI能够高效产出大部分常规内容，人类创作者的角色将如何转变？是成为AI的“监工”，还是专注于AI难以企及的深度创意工作？\n\n**算法偏见与多样性**：AI Agent的训练数据可能包含社会偏见，导致生成内容缺乏多样性或强化刻板印象。开发更公平、包容的AI系统是行业必须面对的课题。\n\n# 06 未来展望：人机协作的新范式\n\nAI Agent不会完全取代人类创作者，而是将催生全新的人机协作模式：\n\n**创意增强而非替代**：未来，人类创作者将更多扮演“创意总监”角色，负责设定方向、提供灵感、把握整体质量，而AI Agent则负责执行具体创作任务，将人类创意高效转化为高质量内容。\n\n**个性化内容经济**：AI Agent使大规模个性化内容生产成为可能，这将催生全新的内容商业模式。消费者不再接受“一刀切”的内容，而是期待完全符合个人兴趣和需求的内容体验。\n\n**实时自适应内容**：结合物联网和实时数据，AI Agent能够创作动态变化的内容。例如，根据天气、地理位置、用户情绪状态实时调整内容表达，提供高度情境化的内容体验。\n\n**跨媒体叙事网络**：AI Agent将能够协调跨平台内容创作，在文章、视频、播客、社交媒体等不同媒介上展开统一叙事，为受众提供多维度的内容体验。\n\n---\n\n当《连线》杂志开始使用AI辅助完成整期专题报道，当《卫报》尝试由AI生成社论，我们已站在内容创作革命的门槛上。**AI Agent不是冰冷的工具，而是有学习能力、能适应环境、可自主进化的创作伙伴**。\n\n未来最成功的内容创作者，将是那些最懂得如何与AI协作的人。他们不抗拒技术浪潮，而是学会驾驭这股力量，将人类独有的创意、情感和价值观与AI的高效执行能力相结合，共同开创内容创作的新纪元。'
    if not article_md:
        print("❌ 文章生成失败，任务终止。")
        return

    # 3. 格式化内容，获取标题和 HTML
    article_title, article_html = markdown_to_html(article_md)
    if not article_html:
        print("❌ 内容格式化失败，任务终止。")
        return
        
    print(f"✅ 内容生成和格式化完成，标题：【{article_title}】")

    # 4. 上传文章草稿 (获取 media_id)
    media_id = upload_material(access_token, article_title, article_html)
    if not media_id:
        print("❌ 文章上传失败，任务终止。")
        return

    # 5. 群发文章
    success = send_article(access_token, media_id)
    
    if success:
        print("--- 🎉 自动化发布任务圆满完成！ ---")
    else:
        print("--- ❌ 自动化发布任务失败。 ---")


# --- 配置和启动任务调度 ---

if __name__ == '__main__':
    # ⚠️ 启动前请确保：
    # 1. config.py 中 APP_ID/SECRET 和 DeepSeek Key 已正确替换。
    # 2. 你已运行 publisher.py 中的图片上传辅助函数，并将获取到的 media_id 填入 config.py。
    
    article_topic = "深度解析 AI Agent 在内容创作领域的革命性影响"
    
    # 1. 立即执行一次测试 (推荐先进行此步骤)
    automated_publishing_task(article_topic)
    
    # 2. 设置定时任务 (如果想启用自动调度，请取消注释以下代码)
    
    # schedule.every().day.at("10:00").do(automated_publishing_task, topic=article_topic)
    # print(f"定时任务已启动，每日 10:00 将自动发布主题为【{article_topic}】的文章。")
    
    # while True:
    #     schedule.run_pending()
    #     time.sleep(1)